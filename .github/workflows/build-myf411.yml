name: Build and Release MyF411

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout 仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 安装构建依赖
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make gcc-arm-none-eabi binutils-arm-none-eabi build-essential

      # 3️⃣ CMake 配置
      - name: Configure (cmake)
        run: |
          mkdir -p build
          cd build
          cmake ..

      # 4️⃣ 构建固件
      - name: Build MyF411
        run: |
          cd build
          make MyF411 -j$(nproc)

      # 5️⃣ 查找生成的 .hex 文件并提取版本号
      - name: Find generated .hex and extract version
        id: find_hex
        run: |
          set -euo pipefail
          echo "Listing build/ for debugging"
          ls -lah build || true
          HEX_PATH=$(ls build/*.hex 2>/dev/null | grep MyF411 || true)
          if [ -z "${HEX_PATH}" ]; then
            echo "No .hex file matching '*MyF411' found in build/"
            exit 1
          fi
          HEX_PATH=$(echo "$HEX_PATH" | head -n1)
          HEX_FILE=$(basename "$HEX_PATH")
          # 尝试从文件名提取版本号，格式 inav_9.0.0_MyF411.hex
          VERSION=$(echo "$HEX_FILE" | sed -n 's/^inav_\([0-9]\+\.[0-9]\+\.[0-9]\+\)_.*\.hex$/\1/p') || true
          if [ -z "$VERSION" ]; then
            VERSION="build-${{ github.run_number }}"
          fi
          echo "hex_file=$HEX_PATH" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # 6️⃣ 创建/更新 Release 并上传 .hex 文件（v2）
      - name: Create/Update GitHub Release and upload .hex
        uses: ncipollo/release-action@v2
        with:
          tag: ${{ steps.find_hex.outputs.version }}
          name: "Release ${{ steps.find_hex.outputs.version }} (MyF411)"
          files: ${{ steps.find_hex.outputs.hex_file }}
          allowUpdates: true
          draft: false
          prerelease: false
